{
    "meta": {
        "type": "db",
        "canSave": false,
        "canEdit": false,
        "canAdmin": false,
        "canStar": true,
        "canDelete": false,
        "slug": "customer-runners-runner-health-overview",
        "url": "/d/k8s-app-health-dashboard/customer-runners-runner-health-overview",
        "expires": "0001-01-01T00:00:00Z",
        "created": "2024-12-25T17:14:21Z",
        "updated": "2025-01-14T06:29:36Z",
        "updatedBy": "sergey.demyachonok@kubiya.ai",
        "createdBy": "sergey.demyachonok@kubiya.ai",
        "version": 47,
        "hasAcl": false,
        "isFolder": false,
        "folderId": 118,
        "folderUid": "ce7de1i4gq8zkc",
        "folderTitle": "Customer Runners",
        "folderUrl": "/dashboards/f/ce7de1i4gq8zkc/customer-runners",
        "provisioned": false,
        "provisionedExternalId": "",
        "annotationsPermissions": {
            "dashboard": {
                "canAdd": false,
                "canEdit": false,
                "canDelete": false
            },
            "organization": {
                "canAdd": false,
                "canEdit": false,
                "canDelete": false
            }
        }
    },
    "dashboard": {
        "annotations": {
            "list": [
                {
                    "builtIn": 1,
                    "datasource": {
                        "type": "grafana",
                        "uid": "-- Grafana --"
                    },
                    "enable": true,
                    "hide": true,
                    "iconColor": "rgba(0, 211, 255, 1)",
                    "name": "Annotations & Alerts",
                    "type": "dashboard"
                }
            ]
        },
        "editable": true,
        "fiscalYearStartMonth": 0,
        "graphTooltip": 1,
        "id": 131,
        "links": [],
        "panels": [
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus-staging"
                },
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "continuous-GrYlRd"
                        },
                        "custom": {
                            "fillOpacity": 70,
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineWidth": 0,
                            "spanNulls": false
                        },
                        "mappings": [
                            {
                                "options": {
                                    "from": 0.8,
                                    "result": {
                                        "color": "green",
                                        "index": 0,
                                        "text": "Up"
                                    },
                                    "to": 1
                                },
                                "type": "range"
                            },
                            {
                                "options": {
                                    "from": 0.5,
                                    "result": {
                                        "color": "yellow",
                                        "index": 1,
                                        "text": "Degraded"
                                    },
                                    "to": 0.8
                                },
                                "type": "range"
                            },
                            {
                                "options": {
                                    "from": 0,
                                    "result": {
                                        "color": "red",
                                        "index": 2,
                                        "text": "Down"
                                    },
                                    "to": 0.59
                                },
                                "type": "range"
                            }
                        ],
                        "max": 1,
                        "min": 0,
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "red",
                                    "value": null
                                },
                                {
                                    "color": "yellow",
                                    "value": 0.5
                                },
                                {
                                    "color": "green",
                                    "value": 0.8
                                }
                            ]
                        }
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 13,
                    "w": 12,
                    "x": 0,
                    "y": 0
                },
                "id": 1,
                "options": {
                    "alignValue": "center",
                    "legend": {
                        "displayMode": "table",
                        "placement": "bottom",
                        "showLegend": true
                    },
                    "mergeValues": true,
                    "rowHeight": 0.9,
                    "showValue": "auto",
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "expr": "(\n  sum by (label_app_kubernetes_io_kubiya_runner_component) (\n    kube_pod_status_ready{namespace=\"$namespace\", runner=\"$runner\", condition=\"true\"}\n    * on (pod) group_left(label_app_kubernetes_io_kubiya_runner_component) \n    (\n      kube_pod_labels{namespace=\"$namespace\", runner=\"$runner\"}\n      and on (pod) kube_pod_labels{label_app_kubernetes_io_kubiya_runner_component!=\"\"}\n    )\n  )\n) \n/ \n(\n  count by (label_app_kubernetes_io_kubiya_runner_component) (\n    kube_pod_labels{namespace=\"$namespace\", runner=\"$runner\", label_app_kubernetes_io_kubiya_runner_component!=\"\"}\n  )\n)",
                        "legendFormat": "{{label_name}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "Components Pods Ready",
                "type": "state-timeline"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus-staging"
                },
                "description": "",
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "fixedColor": "transparent",
                            "mode": "continuous-GrYlRd"
                        },
                        "custom": {
                            "fillOpacity": 75,
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineWidth": 1,
                            "spanNulls": false
                        },
                        "fieldMinMax": true,
                        "mappings": [
                            {
                                "options": {
                                    "0": {
                                        "index": 0,
                                        "text": "Healthy"
                                    }
                                },
                                "type": "value"
                            },
                            {
                                "options": {
                                    "from": 0,
                                    "result": {
                                        "index": 1,
                                        "text": "Down"
                                    },
                                    "to": 10000
                                },
                                "type": "range"
                            }
                        ],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "#EAB839",
                                    "value": 1
                                },
                                {
                                    "color": "light-red",
                                    "value": 5
                                },
                                {
                                    "color": "red",
                                    "value": 15
                                }
                            ]
                        },
                        "unit": "none"
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 13,
                    "w": 12,
                    "x": 12,
                    "y": 0
                },
                "id": 3,
                "options": {
                    "alignValue": "center",
                    "legend": {
                        "displayMode": "list",
                        "placement": "bottom",
                        "showLegend": true
                    },
                    "mergeValues": true,
                    "rowHeight": 0.9,
                    "showValue": "always",
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "pluginVersion": "10.4.11",
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "exemplar": false,
                        "expr": "sum by (label_app_kubernetes_io_kubiya_runner_component) (\n  rate(kube_pod_container_status_restarts_total{\n    namespace=\"$namespace\",\n    runner=\"$runner\"\n  }[5m])\n  * on(pod) group_left(label_app_kubernetes_io_kubiya_runner_component)\n  kube_pod_labels{\n    namespace=\"$namespace\",\n    runner=\"$runner\",\n    label_app_kubernetes_io_kubiya_runner_component!=\"\"\n  }\n) * 300 # Multiply by 300 (seconds in 5m) to show actual restart count",
                        "format": "time_series",
                        "hide": false,
                        "instant": false,
                        "interval": "5m",
                        "legendFormat": "__auto",
                        "range": true,
                        "refId": "B"
                    }
                ],
                "title": "Component Pod’s Containers Restarts [per 5m]",
                "type": "state-timeline"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus-staging"
                },
                "description": "",
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "continuous-GrYlRd"
                        },
                        "custom": {
                            "fillOpacity": 75,
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineWidth": 1,
                            "spanNulls": false
                        },
                        "fieldMinMax": true,
                        "mappings": [
                            {
                                "options": {
                                    "0": {
                                        "color": "red",
                                        "index": 0,
                                        "text": "Down"
                                    },
                                    "1": {
                                        "color": "green",
                                        "index": 1,
                                        "text": "Up"
                                    }
                                },
                                "type": "value"
                            }
                        ],
                        "min": 38,
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                },
                                {
                                    "color": "red",
                                    "value": 0
                                }
                            ]
                        },
                        "unit": "none"
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 9,
                    "w": 12,
                    "x": 0,
                    "y": 13
                },
                "id": 4,
                "options": {
                    "alignValue": "center",
                    "legend": {
                        "displayMode": "list",
                        "placement": "bottom",
                        "showLegend": true
                    },
                    "mergeValues": true,
                    "rowHeight": 0.9,
                    "showValue": "always",
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "pluginVersion": "10.4.11",
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "exemplar": false,
                        "expr": "label_replace(\n  (avg_over_time(probe_success{\n    namespace=\"$namespace\",\n    runner=\"$runner\",\n    exporter=\"blackbox-exporter\"\n  }[5m]) == 1) * 1,\n  \"state\", \"Healthy\", \"\", \"\"\n) or label_replace(\n  (avg_over_time(probe_success{\n    namespace=\"$namespace\",\n    runner=\"$runner\",\n    exporter=\"blackbox-exporter\"\n  }[5m]) == 0) * 1,\n  \"state\", \"Critical\", \"\", \"\"\n)",
                        "format": "time_series",
                        "hide": false,
                        "instant": false,
                        "interval": "5m",
                        "legendFormat": "{{app}}",
                        "range": true,
                        "refId": "A"
                    }
                ],
                "title": "Services Health Endpoint Probe [per 5m]",
                "type": "state-timeline"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus-staging"
                },
                "description": "",
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "thresholds"
                        },
                        "custom": {
                            "fillOpacity": 75,
                            "hideFrom": {
                                "legend": false,
                                "tooltip": false,
                                "viz": false
                            },
                            "insertNulls": false,
                            "lineWidth": 1,
                            "spanNulls": false
                        },
                        "fieldMinMax": true,
                        "mappings": [
                            {
                                "options": {
                                    "95": {
                                        "index": 1,
                                        "text": "Down"
                                    },
                                    "100": {
                                        "index": 0,
                                        "text": "Up"
                                    }
                                },
                                "type": "value"
                            },
                            {
                                "options": {
                                    "match": "null+nan",
                                    "result": {
                                        "index": 2,
                                        "text": "No Data"
                                    }
                                },
                                "type": "special"
                            }
                        ],
                        "noValue": "No Data",
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "red",
                                    "value": null
                                },
                                {
                                    "color": "red",
                                    "value": 95
                                },
                                {
                                    "color": "green",
                                    "value": 100
                                }
                            ]
                        },
                        "unit": "percent"
                    },
                    "overrides": []
                },
                "gridPos": {
                    "h": 9,
                    "w": 12,
                    "x": 12,
                    "y": 13
                },
                "id": 7,
                "options": {
                    "alignValue": "center",
                    "legend": {
                        "displayMode": "list",
                        "placement": "bottom",
                        "showLegend": false
                    },
                    "mergeValues": true,
                    "rowHeight": 0.9,
                    "showValue": "auto",
                    "tooltip": {
                        "mode": "single",
                        "sort": "none"
                    }
                },
                "pluginVersion": "10.4.11",
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "exemplar": false,
                        "expr": "100 * (sum(rate(response_status{status=~\"2..\", runner=\"$runner\", app=\"tool-manager\", kubernetes_namespace=\"$namespace\"}[5m]))/sum(rate(http_requests_total{runner=\"$runner\", app=\"tool-manager\", kubernetes_namespace=\"$namespace\"}[5m])))",
                        "format": "time_series",
                        "hide": false,
                        "instant": false,
                        "interval": "5m",
                        "legendFormat": "agent-manager",
                        "range": true,
                        "refId": "A"
                    },
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "expr": "(100 * (sum(rate(agent_manager_http_requests_total{status=~\"2..\", runner=\"$runner\", app=\"agent-manager\", namespace=\"$namespace\"}[5m]))/sum(rate(agent_manager_http_requests_total{runner=\"$runner\", app=\"agent-manager\", namespace=\"$namespace\"}[5m]))))",
                        "hide": false,
                        "instant": false,
                        "legendFormat": "agent-manager",
                        "range": true,
                        "refId": "B"
                    }
                ],
                "title": "HTTP Requests Success",
                "type": "state-timeline"
            },
            {
                "datasource": {
                    "type": "prometheus",
                    "uid": "prometheus-staging"
                },
                "fieldConfig": {
                    "defaults": {
                        "color": {
                            "mode": "fixed"
                        },
                        "custom": {
                            "align": "auto",
                            "cellOptions": {
                                "type": "auto"
                            },
                            "filterable": true,
                            "inspect": true
                        },
                        "mappings": [],
                        "thresholds": {
                            "mode": "absolute",
                            "steps": [
                                {
                                    "color": "green",
                                    "value": null
                                }
                            ]
                        }
                    },
                    "overrides": [
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "image"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 614
                                },
                                {
                                    "id": "displayName",
                                    "value": "version (container image)"
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "namespace"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 214
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "container"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 221
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "pod (distinctCount)"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 60
                                },
                                {
                                    "id": "displayName",
                                    "value": "# of pods (running this image version)"
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "pod (uniqueValues)"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 20
                                },
                                {
                                    "id": "displayName",
                                    "value": "all pod names (running this image version)"
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "# of pods running this image"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 315
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "# of pods (running this image version)"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 289
                                }
                            ]
                        },
                        {
                            "matcher": {
                                "id": "byName",
                                "options": "all pod names (running this image version)"
                            },
                            "properties": [
                                {
                                    "id": "custom.width",
                                    "value": 1396
                                }
                            ]
                        }
                    ]
                },
                "gridPos": {
                    "h": 13,
                    "w": 24,
                    "x": 0,
                    "y": 22
                },
                "id": 8,
                "options": {
                    "cellHeight": "sm",
                    "footer": {
                        "countRows": false,
                        "fields": "",
                        "reducer": [
                            "sum"
                        ],
                        "show": false
                    },
                    "showHeader": true,
                    "sortBy": [
                        {
                            "desc": false,
                            "displayName": "container"
                        }
                    ]
                },
                "pluginVersion": "10.4.11",
                "targets": [
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "exemplar": false,
                        "expr": "kube_pod_container_info{namespace=~\"$namespace\", runner=\"$runner\", organization=\"$organization\", kubiya_type=\"customers-runners\"}",
                        "format": "table",
                        "instant": true,
                        "legendFormat": "{{container}}",
                        "range": false,
                        "refId": "A"
                    },
                    {
                        "datasource": {
                            "type": "prometheus",
                            "uid": "prometheus-staging"
                        },
                        "editorMode": "code",
                        "exemplar": false,
                        "expr": "kube_pod_labels{namespace=~\"$namespace\", runner=\"$runner\", organization=\"$organization\", kubiya_type=\"customers-runners\"}",
                        "format": "table",
                        "hide": true,
                        "instant": true,
                        "legendFormat": "__auto",
                        "range": false,
                        "refId": "B"
                    }
                ],
                "title": "Components Versions",
                "transformations": [
                    {
                        "id": "filterFieldsByName",
                        "options": {
                            "include": {
                                "names": [
                                    "container",
                                    "image",
                                    "namespace",
                                    "pod",
                                    "label_app_kubernetes_io_instance",
                                    "label_app_kubernetes_io_kubiya_runner_component",
                                    "label_app_kubernetes_io_name",
                                    "label_pod_template_hash",
                                    "label_app_kubernetes_io_managed_by",
                                    "label_app_kubernetes_io_part_of",
                                    "label_app_kubernetes_io_version",
                                    "label_helm_sh_chart",
                                    "label_controller_revision_hash",
                                    "label_name",
                                    "label_pod_template_generation",
                                    "label_app_kubernetes_io_component",
                                    "label_run"
                                ]
                            }
                        }
                    },
                    {
                        "id": "groupBy",
                        "options": {
                            "fields": {
                                "container": {
                                    "aggregations": [],
                                    "operation": "groupby"
                                },
                                "image": {
                                    "aggregations": [],
                                    "operation": "groupby"
                                },
                                "namespace": {
                                    "aggregations": [],
                                    "operation": "groupby"
                                },
                                "pod": {
                                    "aggregations": [
                                        "distinctCount",
                                        "uniqueValues"
                                    ],
                                    "operation": "aggregate"
                                }
                            }
                        }
                    }
                ],
                "type": "table"
            }
        ],
        "refresh": "5m",
        "schemaVersion": 39,
        "tags": [
            "kubernetes",
            "health",
            "metrics",
            "customer_runner"
        ],
        "templating": {
            "list": [
                {
                    "current": {
                        "selected": false,
                        "text": "kubiya-test-sniff",
                        "value": "kubiya-test-sniff"
                    },
                    "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus-staging"
                    },
                    "definition": "label_values(up{kubiya_type=\"customers-runners\"},organization)",
                    "hide": 0,
                    "includeAll": false,
                    "label": "",
                    "multi": false,
                    "name": "organization",
                    "options": [],
                    "query": {
                        "qryType": 1,
                        "query": "label_values(up{kubiya_type=\"customers-runners\"},organization)",
                        "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 1,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                },
                {
                    "current": {
                        "selected": false,
                        "text": "sergey-metrics-test",
                        "value": "sergey-metrics-test"
                    },
                    "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus-staging"
                    },
                    "definition": "label_values(up{kubiya_type=\"customers-runners\", organization=~\"$organization\"},runner)",
                    "hide": 0,
                    "includeAll": false,
                    "label": "",
                    "multi": false,
                    "name": "runner",
                    "options": [],
                    "query": {
                        "qryType": 1,
                        "query": "label_values(up{kubiya_type=\"customers-runners\", organization=~\"$organization\"},runner)",
                        "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 1,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                },
                {
                    "current": {
                        "selected": false,
                        "text": "kubiya",
                        "value": "kubiya"
                    },
                    "datasource": {
                        "type": "prometheus",
                        "uid": "prometheus-staging"
                    },
                    "definition": "label_values(up{kubiya_type=\"customers-runners\", organization=~\"$organization\",runner=\"$runner\"},namespace)",
                    "hide": 0,
                    "includeAll": false,
                    "label": "",
                    "multi": false,
                    "name": "namespace",
                    "options": [],
                    "query": {
                        "qryType": 1,
                        "query": "label_values(up{kubiya_type=\"customers-runners\", organization=~\"$organization\",runner=\"$runner\"},namespace)",
                        "refId": "PrometheusVariableQueryEditor-VariableQuery"
                    },
                    "refresh": 1,
                    "regex": "",
                    "skipUrlSync": false,
                    "sort": 0,
                    "type": "query"
                }
            ]
        },
        "time": {
            "from": "now-3h",
            "to": "now-1m"
        },
        "timepicker": {
            "nowDelay": "1m",
            "refresh_intervals": [
                "5m",
                "15m",
                "30m",
                "1h",
                "2h",
                "1d"
            ]
        },
        "timezone": "browser",
        "title": "Customer Runners / Runner Health Overview",
        "uid": "k8s-app-health-dashboard",
        "version": 47,
        "weekStart": ""
    }
}